name: Nightly Agent Pipeline

on:
  # Run nightly at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'
  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-agent-pipeline:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run complete agent pipeline
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
        run: |
          echo "Running complete agent pipeline..."
          echo "Note: Script implementation required for production"
          # TODO: Implement script in scripts/run-agent-pipeline.js
          # node scripts/run-agent-pipeline.js
          
      - name: Create pull request with new templates
        if: success()
        run: |
          git config --local user.email "agent@gameforge.app"
          git config --local user.name "GameForge Agent"
          
          # Check if there are changes to commit
          if [ -n "$(git status --porcelain)" ]; then
            BRANCH_NAME="agent/templates-$(date +%Y%m%d-%H%M%S)"
            git checkout -b "$BRANCH_NAME"
            git add templates/experimental/
            git commit -m "feat: Add experimental templates from nightly agent run"
            git push origin "$BRANCH_NAME"
            
            # Create PR (requires gh CLI or API call)
            echo "Created branch $BRANCH_NAME with new templates"
            echo "TODO: Create PR via GitHub API or gh CLI"
          else
            echo "No new templates to commit"
          fi
          
      - name: Notify on success
        if: success()
        run: |
          echo "✅ Nightly agent pipeline completed successfully"
          
      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Nightly agent pipeline failed"
