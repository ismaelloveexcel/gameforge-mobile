name: Nightly Agent Pipeline

on:
  # Run nightly at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'
  # Allow manual trigger
  workflow_dispatch:

jobs:
  run-agent-pipeline:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run market research agent
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
        run: |
          echo "Running market research agent..."
          # This would call a script that runs the agent orchestrator
          # node scripts/run-agent-pipeline.js research
          
      - name: Generate new template ideas
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
        run: |
          echo "Generating new template ideas..."
          # node scripts/run-agent-pipeline.js generate-ideas
          
      - name: Create experimental templates
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
        run: |
          echo "Creating experimental templates..."
          # node scripts/run-agent-pipeline.js create-templates
          
      - name: Test generated templates
        run: |
          echo "Testing generated templates..."
          # node scripts/run-agent-pipeline.js test-templates
          
      - name: Commit experimental templates
        run: |
          git config --local user.email "agent@gameforge.app"
          git config --local user.name "GameForge Agent"
          
          # Check if there are changes to commit
          if [ -n "$(git status --porcelain)" ]; then
            git add templates/experimental/
            git commit -m "feat: Add experimental templates from nightly agent run [skip ci]"
            git push
          else
            echo "No new templates to commit"
          fi
          
      - name: Generate pipeline report
        run: |
          echo "Generating pipeline report..."
          # node scripts/generate-agent-report.js
          
      - name: Notify on success
        if: success()
        run: |
          echo "✅ Nightly agent pipeline completed successfully"
          # Could send notification to Slack/Discord/Email
          
      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Nightly agent pipeline failed"
          # Could send alert notification
